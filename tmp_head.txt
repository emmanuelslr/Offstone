'use client';

import React, { useEffect, useRef, useState } from 'react';
import { motion, useInView } from 'framer-motion';
import Image from 'next/image';
import ParaformRightHeroCardsStep from '@/components/ParaformRightHeroCardsStep';
import SectionBadge from './SectionBadge';
import PlatformDigitale from '../../../../public/images/Platform/New offstone platform.png';
import OffDealAdvantageLike from './OffDealAdvantageLike';

export default function AdvantageOffstoneSection() {
  const videoRef = useRef<HTMLVideoElement>(null);
  const sectionRef = useRef<HTMLDivElement>(null);
  const titleRef = useRef<HTMLDivElement>(null);
  const cardRef = useRef<HTMLDivElement>(null);
  const [isVisible, setIsVisible] = useState(false);
  const [titleVisible, setTitleVisible] = useState(false);
  const [reveal, setReveal] = useState(0);
  const [badgeVisible, setBadgeVisible] = useState(false);
  
  // États pour les compteurs animés
  const [counter17, setCounter17] = useState(0);
  const [animationStarted, setAnimationStarted] = useState(false);
  
  // Hook pour détecter la visibilité de la carte
  const cardInView = useInView(cardRef, { 
    once: false, // Se réactive à chaque fois qu'on revoit la section
    amount: 0.3 
  });

  useEffect(() => {
    if (titleVisible) {
      const timeout = setTimeout(() => setBadgeVisible(true), 600);
      return () => clearTimeout(timeout);
    } else {
      setBadgeVisible(false);
    }
  }, [titleVisible]);

  // Effect pour les animations des compteurs
  useEffect(() => {
    if (cardInView && !animationStarted) {
      setAnimationStarted(true);
      
      // Délai pour commencer après l'apparition de la carte (0.7s)
      setTimeout(() => {
        // Animation du compteur 17%
        let current17 = 0;
        const timer17 = setInterval(() => {
          current17 += 1;
          setCounter17(current17);
          if (current17 >= 17) {
            clearInterval(timer17);
          }
        }, 80); // 80ms par étape pour une animation plus visible

      }, 700); // Délai pour attendre l'animation de zoom de la carte

    } else if (!cardInView) {
      // Reset quand on sort de la vue
      setAnimationStarted(false);
      setCounter17(0);
    }
  }, [cardInView, animationStarted]);

  useEffect(() => {
    // Déclenche l'animation du titre quand la section entre dans le viewport (une seule fois)
    const handleScroll = () => {
      if (titleVisible) return;
      if (!sectionRef.current) return;
      const rect = sectionRef.current.getBoundingClientRect();
      const windowHeight = window.innerHeight || document.documentElement.clientHeight;
      if (rect.top < windowHeight - 20) {
        setTitleVisible(true);
      }
    };
    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
    return () => window.removeEventListener('scroll', handleScroll);
  }, [titleVisible]);

  // Animation reveal progress for the title (scroll-based, like TextReveal)
  useEffect(() => {
    const handleScroll = () => {
      if (!titleRef.current) return;
      const rect = titleRef.current.getBoundingClientRect();
      const windowHeight = window.innerHeight || document.documentElement.clientHeight;
      const revealStart = rect.top - windowHeight * 0.7;
      const revealEnd = rect.bottom - windowHeight * 0.3;
      let p = 0;
      if (revealEnd <= 0) {
        p = 1;
      } else if (revealStart >= 0) {
        p = 0;
      } else {
        p = 1 - revealEnd / (rect.height + windowHeight * 0.4);
        p = Math.max(0, Math.min(1, p));
      }
      setReveal(p);
    };
    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Utilise IntersectionObserver pour détecter la visibilité de la vidéo
  useEffect(() => {
    const video = videoRef.current;
    if (!video) return;
    let observer: IntersectionObserver | null = null;
    observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            setIsVisible(true);
            if (videoRef.current) {
              videoRef.current.currentTime = 0;
              videoRef.current.play();
            }
          } else {
            setIsVisible(false);
          }
        });
      },
      {
        threshold: 0.1,
      }
    );
    observer.observe(video);
    return () => {
      if (observer && video) observer.unobserve(video);
    };
  }, []);

  useEffect(() => {
    if (videoRef.current) {
      if (isVisible) {
        videoRef.current.play();
      } else {
        videoRef.current.pause();
      }
    }
  }, [isVisible]);

  useEffect(() => {
    if (videoRef.current) {
      videoRef.current.playbackRate = 6.5;
    }
  }, []);

  return (
    <section>
      {/* Première section - Titre et Vidéo */}
      <div ref={sectionRef} className="w-full bg-[#F7F6F1] pt-16 md:pt-20 lg:pt-24 xl:pt-32 pb-6 md:pb-8 lg:pb-10 xl:pb-12">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          {badgeVisible && (
            <div className="flex justify-center mb-6 md:mb-8 transition-opacity duration-700 opacity-100">
              <SectionBadge colorClass="text-gray-600" text="IMMEUBLES EXCLUSIFS" />
            </div>
          )}
        <div
          ref={titleRef}
          className={`text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl 2xl:text-[3.5rem] text-center font-light text-[#111] transition-all duration-[1800ms] ease-out mb-8 md:mb-12 lg:mb-16 ${
            titleVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-8'
          }`}
          style={{ fontFamily: 'AllianceNo1-Regular, sans-serif' }}
          id="advantage-title"
        >
          {(() => {
            // Two lines, keep <br />
            const text = ["L'avantage d'investir", "avec Offstone."];
            const allLetters = text.join('');
            const totalLetters = allLetters.length;
            const revealedCount = Math.floor(reveal * totalLetters);
            let letterIndex = 0;
            return text.map((line, lineIdx) => (
              <React.Fragment key={lineIdx}>
                {line.split('').map((char, i) => {
                  const isRevealed = letterIndex < revealedCount;
                  const span = (
                    <span
                      key={i}
                      style={{
                        color: isRevealed ? '#111' : '#928D80',
                        transition: 'color 0.3s cubic-bezier(.77,0,.18,1)',
                        willChange: 'color',
                      }}
                    >
                      {char}
                    </span>
                  );
                  letterIndex++;
                  return span;
                })}
                {lineIdx === 0 && <br />}
              </React.Fragment>
            ));
          })()}
        </div>
        <div className="flex justify-center mb-6 md:mb-8">
          <button
            className="inline-flex items-center justify-center h-11 bg-black text-white font-normal rounded-full px-6 text-base shadow-sm border border-black transition hover:bg-[#F7B096] hover:text-black hover:border-[#F7B096] group"
            type="button"
          >
            Investir
            <svg
              className="ml-2 w-4 h-4 transition-transform group-hover:translate-x-1 group-hover:-translate-y-1"
              fill="none"
              stroke="currentColor"
              strokeWidth={1.1}
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" d="M7 17L17 7M7 7h10v10" />
            </svg>
          </button>
        </div>
        {/* Container vidéo responsive */}
        <div className="flex justify-center">
          <div className="w-[90vw] mx-[calc(50%-45vw)] md:w-[88vw] md:mx-[calc(50%-44vw)] xl:w-[82vw] xl:mx-[calc(50%-41vw)] 2xl:w-[78vw] 2xl:mx-[calc(50%-39vw)] max-w-[1560px] xl:max-w-[1720px] 2xl:max-w-[1880px] aspect-[16/9] bg-[#F6F4F0] rounded-lg lg:rounded-xl overflow-hidden relative flex items-center justify-center">
            <video
              ref={videoRef}
              className="w-full h-full object-contain object-top"
              src="/videos/TEST3_Component AdvantageOffStone.mp4"
              muted
              playsInline
              controls={false}
              style={{ background: '#F7F6F1' }}
              onEnded={() => {
                if (videoRef.current) {
                  videoRef.current.currentTime = videoRef.current.duration - 0.1;
                  videoRef.current.pause();
                }
              }}
            />
            <div className="pointer-events-none absolute top-0 left-0 right-0 h-2 sm:h-3 md:h-4 bg-[#F6F4F0]" />
            <div className="pointer-events-none absolute bottom-0 left-0 right-0 h-2 sm:h-3 md:h-4 bg-[#F6F4F0]" />
          </div>
        </div>
        </div>
      </div>
      
      {/* Deuxième section - Sourcing Unique */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 md:pt-8 lg:pt-10 xl:pt-12 pb-16 md:pb-20 lg:pb-24 xl:pb-32">
        <div className="flex flex-col lg:flex-row items-center lg:items-start gap-8 lg:gap-12 xl:gap-16">
          {/* Section gauche - Texte */}
          <div className="w-full lg:w-1/2 order-2 lg:order-1 lg:min-h-[600px] flex items-center">
            <div className="w-full">
              <div className="mb-6">
                <SectionBadge colorClass="text-gray-600" text="SOURCING UNIQUE" />
              </div>
              <h2
                className={`text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl 2xl:text-[66px] font-normal tracking-tighter leading-tight text-[#111] mb-6 lg:mb-8 transition-all duration-[1200ms] ease-out ${
                  titleVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-8'
                }`}
              >
                Accédez à des opportunités <span style={{ color: '#9D9F9E' }}>exclusives.</span>
              </h2>
              <p className="text-base md:text-lg lg:text-xl text-gray-600 mb-8 lg:mb-12 max-w-xl leading-relaxed">
                Chaque projet à accès réservé,<br />
                issu d&apos;un sourcing propriétaire, structuré<br />
                par notre méthode et co-investi à vos côtés.
              </p>
              <button
                className="inline-flex items-center justify-center h-11 bg-black text-white font-normal rounded-full px-6 text-base shadow-sm border border-black transition hover:bg-white hover:text-black hover:border-black group"
                type="button"
              >
                Parler à un expert
                <svg
                  className="ml-2 w-4 h-4 transition-transform group-hover:translate-x-1 group-hover:-translate-y-1"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth={1.1}
                  viewBox="0 0 24 24"
                >
                  <path strokeLinecap="round" strokeLinejoin="round" d="M7 17L17 7M7 7h10v10" />
                </svg>
              </button>
            </div>
          </div>

          {/* Section droite - Composant Paraform responsive */}
          <div className="w-full lg:w-1/2 order-1 lg:order-2 lg:min-h-[600px] flex items-center justify-center lg:justify-end lg:pr-8 xl:pr-12 2xl:pr-16">
            <div className="w-full max-w-sm sm:max-w-md md:max-w-lg lg:max-w-[600px]">
              <ParaformRightHeroCardsStep
                size={600}
                gap={18}
                intervalMs={2600}
                cards={[
                  { id: "2barbes", image: "/images/Buildings/rue-la-boetie-11-copie-scaled.jpg" },
                  { id: "truchet", image: "/images/Buildings/Truchet.jpg" },
                  { id: "ienaa",  image: "/images/Buildings/Ienaa.jpg" },
                ]}
              />
            </div>
          </div>
        </div>
      </div>
